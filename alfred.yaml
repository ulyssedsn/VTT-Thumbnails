version: '3.4'

x-alfred-steps-pre:
  - name: Docker build and push to AWS ECR dev images
    image: wuakitv/alfred-ecr
    when:
      branch:
        - ^((?!main).)*$
    settings:
      aws_access_key_id:
        from_consul: prod/bot-bumblebee-ecr/aws_access_key_id
      aws_secret_access_key:
        from_consul_secret: prod/bot-bumblebee-ecr/aws_secret_access_key
      repo: wuakitv/bumblebee
      ecr_uri: 585257864808.dkr.ecr.eu-west-1.amazonaws.com
      tags:
        - ${GIT_TAG}
        - ${GIT_COMMIT}
        - dev-${GIT_COMMIT}

  - name: Docker build and push to AWS ECR prod images
    image: wuakitv/alfred-ecr
    when:
      branch:
        - main
    settings:
      aws_access_key_id:
        from_consul: prod/bot-bumblebee-ecr/aws_access_key_id
      aws_secret_access_key:
        from_consul_secret: prod/bot-bumblebee-ecr/aws_secret_access_key
      repo: wuakitv/bumblebee
      ecr_uri: 585257864808.dkr.ecr.eu-west-1.amazonaws.com
      tags:
        - ${GIT_TAG}
        - ${GIT_COMMIT}
        - prod-${GIT_COMMIT}

x-kiuwan-enable: false
